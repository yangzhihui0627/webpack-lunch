var jquery = require("jquery");
let socket = require("./socket.client.js");

//用户监听服务器端推送其它人选择后的消息 
socket.on("selected",function(data){
    console.log("我是服务器返回的消息:"+data.name + " count:"+data.sum);
    var lis = document.querySelectorAll(".mui-table-view-cell a");
    lis.forEach(function(item,index){
        if(item.name.indexOf(data.name) > -1){
           item.text = data.name+"("+data.sum+")";
        }
    })
})
socket.on("new",function(data){
    console.log('我是服务器返回的消息:'+data.message);
})
socket.emit("new",navigator.userAgent);
document.onreadystatechange = function () {
  // 页面加载完成后请求点餐信息
  if (document.readyState === "complete") {
    jquery.ajax({
        url: "/selectAll",
        data: {
            name: 'test'
        },
        async: false,
        type: "get",
        dataType: "json",
        success: function (res) {
            if (res.status === "success") {
                console.log("返回数据"+res);
                var rels = JSON.parse(res.data);
                var uls = document.getElementById("list");
                rels.forEach(function(item,index){
                    console.log(item.name)
                    // let name = document.getElementsByName(item.name);
                    // name[0].text = item.name + '('+item.count+')';
                    var li = document.createElement("li");
                    li.className = 'mui-table-view-cell';
                    var a = document.createElement("a");
                    a.href = '#';
                    a.name = item.name;
                    a.text = item.name + '('+item.count+')';
                    li.appendChild(a);
                    
                    uls.appendChild(li);
                })
                
            } else {
                console.error("返回数据失败");
            }
        }
    });
  }
}
document.addEventListener("click",function(event){
  if(event.target.nodeName == 'A'){
    console.log(event.target.name)
    //控制同一种类被多次点击
    if(localStorage.getItem("selectTime")){
        var curTime = new Date().getTime();
        if((curTime - localStorage.getItem("selectTime"))< 864000){
            alert("等会再点吧,选一次就好~")
        }else{
            sendRequest("countCategory",event.target.name);
        }
    }else{
        localStorage.setItem("selectTime",new Date().getTime());
        sendRequest("countCategory",event.target.name);   
    }

  }else if(event.target.id == "add"){
    addLi();
  }else if(event.target.id == "reset"){
    reset();
  }
},false)

function sendRequest(type,name){
    socket.emit("selected",name);
	jquery.ajax({
            url: "/"+type,
            data: {
                name: name
            },
            async: false,
            type: "get",
            dataType: "json",
            success: function (results) {
                if (results.status === "success") {
                    console.log("添加成功");
                    jquery.ajax({
                        url: "/selectAll",
                        data: {
                            name: 'test'
                        },
                        async: false,
                        type: "get",
                        dataType: "json",
                        success: function (res) {
                            if (res.status === "success") {
                                console.log("返回数据"+res);
                                var as = document.querySelectorAll(".mui-table-view-cell a");
                                var rels = JSON.parse(res.data);
                                rels.forEach(function(item,index){
                                    console.log(item.name)
                                    let name = document.getElementsByName(item.name);
                                    name[0].text = item.name + '('+item.count+')';
                                })
                                document.location.reload();
                            } else {
                                console.error("返回数据失败");
                            }
                        }
                    });
                } else {
                    console.error("添加失败");
                }
            }
        });
}

function addLi(){
    var inputValue = document.getElementById("inputValue");
    let name = inputValue.value;
    if(name){
        jquery.ajax({
            url: "/addCategory",
            data: {
                name: name
            },
            async: false,
            type: "get",
            dataType: "json",
            success: function (res) {
                if (res.status === "success") {
                    // 后台入库成功后页面中添加显示项
                    var li = document.createElement("li");
                    li.className = 'mui-table-view-cell';
                    var a = document.createElement("a");
                    a.href = '#';
                    a.name = name;
                    a.text = name + '(0)';
                    li.appendChild(a);
                    var uls = document.getElementById("list");
                    uls.appendChild(li);
                }else if(res.status === "rename"){
                    alert("已存在此餐馆");
                }else {
                    console.error("返回数据失败");
                }
            }
        });
    }
    
}

function reset(){
    jquery.ajax({
            url: "/reset",
            data: {
                name: ""
            },
            async: false,
            type: "get",
            dataType: "json",
            success: function (res) {
                if (res.status === "success") {
                    document.location.reload();
                }else if(res.status === "error"){
                    alert("清空失败");
                }else {
                    console.error("返回数据失败");
                }
            }
        });
}